# PR Metrics

PR Metrics is an Azure Pipelines task for adding size and test coverage
indicators to the start of each Pull Request title.

For example, a PR with the title "Adding code" could become either:

- XS:heavy_check_mark: :black_small_square: Adding code
- L:warning: :black_small_square: Adding code

The former would indicate an extra small PR with sufficient test coverage,
whereas the latter would indicate a large PR with insufficient test coverage.

This task helps ensure engineers keep PRs to an appropriate size with
appropriate test coverage, while informing reviewers of the expected time
commitment for a thorough review of the code.

The task will also add a comment to the PR with a detailed breakdown of the
metrics:

> # Metrics for iteration 1
> :heavy_check_mark: Thanks for keeping your pull request small.
>
> :heavy_check_mark: Thanks for adding tests.
>
> |              | Lines   |
> | ------------ | ------: |
> | Product Code |   100   |
> | Test Code    |    50   |
> | **Subtotal** | **150** |
> | Ignored      |     5   |
> | **Total**    | **155** |

It will furthermore add a comment to indicate that a review of the file may not
be necessary.

> :exclamation: **This file may not need to be reviewed.**

Finally, if no PR description is provided, the description will be set to:

> :x: **Please add a description.**

## Deploying

The task can be used with either [Azure Pipelines][azurepipelines] or a local
instance of [Azure DevOps Server/Team Foundation Server][azureserver] 2017
Update 1 or above.

To deploy the task:

1. Acquire administrator access to the server to which you wish to deploy.
1. Install [tfx-cli][tfxcli] using [npm][npm] via the command-line
   `npm install -g tfx-cli`.
1. Sign in to the server using
   `tfx login --service-url https://<account>.visualstudio.com/DefaultCollection --token <PAT>`.
   You can generate a PAT by visiting
   `https://dev.azure.com/<account>/_usersSettings/tokens` and clicking "New
   Token". Select "Full access" and adjust the rest of settings as desired. This
   will only need to be performed the first time you use tfx-cli.
1. Delete any existing copy of the task using
   `tfx build tasks delete --task-id 99492a90-fc6e-11e6-a1fd-39c537974205`.
1. Build the task locally by running `msbuild` from the PRMetrics directory.
   You may need to use a Visual Studio command prompt for this, as `msbuild` is
   not always added to the default path.
1. If the build is successful, upload the task using
   `tfx build tasks upload --task-path ..\ExtensionPackage\PRMetrics\`.

## Configuring

The task can be added to a pipeline as detailed [here][addingtask]. Note that
only Windows pipelines are supported as the task is written in PowerShell.

The agent running the task must allow access to the OAuth token. If access is
unavailable, the task will generate a warning.

It is recommended to add a custom run condition of
`and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))`. If the task is
not run via a pull request, it will generate a warning. Adding this condition
avoids the warning.

It is also recommended to run the task as one of the first operations in your
build, after code check out is complete. Running the task early in the build
process allows for the title to be updated quickly, avoiding the need for
engineers to wait a long time for the title update.

### Parameters

The task parameters are:

- **Base Size:** The maximum number of new lines in a small PR. If left blank,
  a default of `250` will be used.
- **Growth Rate:** The growth rate applied to the base size for calculating the
  size of larger PRs. If left blank, a default of `2.0` will be used. With a
  base size of `250` and a growth rate of `2.0`, `500` new lines would
  constitute a medium PR while `1000` new lines would constitute a large PR.
- **Test Factor:** The lines of test code expected for each line of product
  code. If left blank, a default of `1.5` will be used. This can be set to `0.0`
  in order to skip the reporting of whether the test code coverage is
  sufficient.
- **File Matching Patterns:** [Azure DevOps file matching patterns][globs]
  specifying the files and folders to include. Autogenerated files should
  typically be excluded. Excluded files will contain a comment to inform
  reviewers that they are unlikely to need to review those files. If left
  blank, a default of `**/*` (all files) will be used.
- **Code File Extensions:** Extensions for files containing code, so that
  non-code files can be excluded. If left blank, a default set of file
  extensions will be used, which are listed at
  [the end of this file](#default-code-file-extensions).

### YAML

Sample YAML for adding the task is as follows. The default parameter values are
expected to be appropriate for most repos. Therefore, the `inputs` can typically
be excluded.

```YAML
steps:
- task: microsoft.omex-azure-devops-extension.99492a90-fc6e-11e6-a1fd-39c537974205.PRMetrics@4
  displayName: 'PR Metrics'
  inputs:
    BaseSize: 250
    GrowthRate: 2.0
    TestFactor: 1.5
    FileMatchingPatterns: |
      **/*
      !Ignore.cs
    CodeFileExtensions: |
      cs
      ps1
  continueOnError: true
  condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
```

## Implementation

This task is written in PowerShell using the [Azure Pipelines Task SDK][sdk].

It works by querying Git for changes using the command
`git diff --numstat origin/<target>...pull/<pull_request_id>/merge`. Files with
`test` in the file or directory name (irrespective of case) are considered test
files. All other files are considered product code files.

Note that this task is designed to give a quick estimate of the size of a change
and its test coverage. It is not an authoritative metric and should not be
treated as such. For example, the task should not be used to replace
comprehensive and thorough code coverage metrics. Instead, the task should
merely be considered a guideline for influencing optimal PR behavior.

## Testing

This task is tested via unit and integration tests constructed using the
[Pester][pester] test framework. The code coverage is currently extremely high,
and a high rate of coverage should be maintained for all changes. Validating
this task on the server is significantly more expensive than validating locally.

The task contains no violations of the [PSScriptAnalyzer][psscriptanalyzer]
rules. This compliance with the PSScriptAnalyzer rules should also be maintained
for all new code.

You can run Pester and PSScriptAnalyzer across all task files by running the
following from a PowerShell terminal:

```PowerShell
.\Tools\Validate.ps1
```

## Debugging

To gain greater insight into the cause of failures, you can set the
`system.debug` variable to `true` for your build pipeline. This will output
significant additional debugging information, including a full trace of the
methods called, which can be used for posting bug reports, etc.

If a failure occurs during the task, full debugging information will be
outputted by default irrespective of the value of the `system.debug` variable.

## Default Code File Extensions

The default value for the Code File Extensions parameter outlined
[above](#parameters) is:

```Text
ada
adb
ads
asm
bas
bb
bmx
c
cbl
cbp
cc
clj
cls
cob
cpp
cs
cxx
d
dba
e
efs
egt
el
f
f77
f90
for
frm
frx
fth
ftn
ged
gm6
gmd
gmk
gml
go
h
hpp
hs
hxx
i
inc
java
l
lgt
lisp
m
m4
ml
msqr
n
nb
p
pas
php
php3
php4
php5
phps
phtml
piv
pl
pl1
pli
pm
pol
pp
prg
pro
py
r
rb
red
reds
rkt
rktl
s
scala
sce
sci
scm
sd7
skb
skc
skd
skf
skg
ski
skk
skm
sko
skp
skq
sks
skt
skz
spin
stk
swg
tcl
vb
xpl
xq
xsl
y
```

[azurepipelines]: https://azure.microsoft.com/services/devops/pipelines/
[azureserver]: https://azure.microsoft.com/services/devops/server/
[tfxcli]: https://github.com/Microsoft/tfs-cli
[npm]: https://www.npmjs.com/
[addingtask]: https://docs.microsoft.com/azure/devops/pipelines/customize-pipeline
[globs]: https://docs.microsoft.com/azure/devops/pipelines/tasks/file-matching-patterns
[sdk]: https://github.com/microsoft/azure-pipelines-task-lib
[pester]: https://github.com/pester/Pester
[psscriptanalyzer]: https://github.com/PowerShell/PSScriptAnalyzer
